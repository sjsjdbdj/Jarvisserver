<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JARVIS Asistente</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Estilos anteriores se mantienen igual... */
    :root {
      --bg-color: #f0f8ff;
      --accent: #0077ff;
      --text-color: #000e1a;
      --chat-bg: rgba(255, 255, 255, 0.75);
    }
    
    body.dark {
      --bg-color: #0a0f1c;
      --accent: #00bfff;
      --text-color: #d6faff;
      --chat-bg: rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg-color);
      font-family: 'Orbitron', sans-serif;
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
      transition: background 0.4s, color 0.4s;
    }

    .toggle-btn {
      margin: 12px;
      padding: 6px 14px;
      background: var(--accent);
      border: none;
      color: #fff;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .jarvis-core {
      margin: 20px auto 10px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      width: 200px;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
      position: relative;
    }

    .jarvis-core::before {
      content: "";
      position: absolute;
      width: 250px;
      height: 250px;
      border: 2px dotted var(--accent);
      border-radius: 50%;
      animation: spin 12s linear infinite;
    }
    
    .jarvis-core.listening {
      animation: pulse-fast 0.8s infinite;
      background-color: rgba(var(--accent-rgb), 0.2);
    }
    
    .jarvis-core.listening::before {
      animation: spin 4s linear infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 10px var(--accent); }
      50% { box-shadow: 0 0 20px var(--accent); }
      100% { box-shadow: 0 0 10px var(--accent); }
    }
    
    @keyframes pulse-fast {
      0% { box-shadow: 0 0 10px var(--accent); }
      50% { box-shadow: 0 0 30px var(--accent); }
      100% { box-shadow: 0 0 10px var(--accent); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    h1 {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--accent);
    }
    
    .info-bar {
      display: flex;
      justify-content: space-between;
      width: 95%;
      max-width: 720px;
      margin-bottom: 10px;
      color: var(--accent);
      font-size: 0.9rem;
    }

    .chat-container {
      width: 95%;
      max-width: 720px;
      height: 440px;
      background: var(--chat-bg);
      border: 1px solid var(--accent);
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 14px rgba(0,0,0,0.15);
      backdrop-filter: blur(6px);
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      font-size: 0.9rem;
      scroll-behavior: smooth;
    }

    .chat-messages div {
      margin: 6px 0;
      line-height: 1.4;
    }

    .chat-input {
      display: flex;
      border-top: 1px solid var(--accent);
    }

    .chat-input input {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: var(--text-color);
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      outline: none;
    }

    .chat-input button {
      padding: 0 14px;
      background: var(--accent);
      border: none;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 0.9rem;
    }
    
    .voice-btn {
      padding: 0 14px;
      background: var(--accent);
      border: none;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .voice-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }
    
    .weather-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
    }
    
    .weather-info img {
      width: 32px;
      height: 32px;
    }

    /* Control de volumen */
    .volume-control {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }
    
    .volume-control input {
      width: 100px;
    }

    /* Indicador de comandos activos */
    .command-active {
      color: #00ff88;
      animation: glow 1.5s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from { text-shadow: 0 0 5px #00ff88; }
      to { text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88; }
    }

    /* Bot√≥n para limpiar historial */
    .clear-history-btn {
      margin: 5px;
      padding: 4px 10px;
      background: #ff4444;
      border: none;
      color: #fff;
      font-size: 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .clear-history-btn:hover {
      background: #ff0000;
    }

    @media (max-width: 600px) {
      .jarvis-core {
        width: 160px;
        height: 160px;
      }

      .jarvis-core::before {
        width: 200px;
        height: 200px;
      }

      .chat-container {
        height: 400px;
      }
      
      .info-bar {
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Secci√≥n de autenticaci√≥n -->
  {% if user %}
    <div style="margin:10px;">
      Bienvenido, {{ user.name }} |
      <a href="/logout">Cerrar sesi√≥n</a>
    </div>
  {% endif %}

  {% if not user %}
    <div style="margin-top:50px;text-align:center;">
      <a href="/login">
        <button class="toggle-btn">Iniciar sesi√≥n con Google</button>
      </a>
    </div>
  {% endif %}

  <button class="toggle-btn" onclick="toggleTheme()">Modo Claro/Oscuro</button>
  <button class="clear-history-btn" onclick="clearChatHistory()">Limpiar Historial</button>
  
  <div class="jarvis-core" id="jarvisCore"></div>
  
  <h1 id="mainTitle">
    {% if user %}
      Bienvenido de vuelta, {{ user.name.split.0 if user.name else 'Se√±or' }}
    {% else %}
      Bienvenido, Humano
    {% endif %}
  </h1>
  
  <div class="info-bar">
    <div id="dateTime">Cargando fecha y hora...</div>
    <div id="weatherInfo" class="weather-info">Cargando clima...</div>
  </div>
  
  <!-- Indicador de comandos disponibles -->
  <div id="commandIndicator" style="margin: 5px 0; color: var(--accent); font-size: 0.8rem; display: none;">
    <span class="command-active">‚úì Comandos de Calendario y Tareas Disponibles</span>
  </div>
  
  <div class="chat-container">
    <div class="chat-messages" id="chatMessages">
      <!-- El historial se cargar√° desde localStorage -->
    </div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Escribe tu mensaje o comando..." />
      <button class="voice-btn" id="voiceButton">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
          <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
        </svg>
      </button>
      <button id="sendButton">Enviar</button>
    </div>
  </div>
  
  <div class="volume-control">
    <span>Volumen voz:</span>
    <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="0.8">
  </div>
  
  <!-- Panel de ayuda para comandos -->
  <div id="helpPanel" style="margin-top: 15px; max-width: 720px; display: none;">
    <details>
      <summary style="color: var(--accent); cursor: pointer; font-size: 0.9rem;">üìã Ver comandos disponibles</summary>
      <div style="background: var(--chat-bg); padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 0.85rem;">
        <div><strong>üóìÔ∏è Comandos de Calendario:</strong></div>
        <div>‚Ä¢ "Crea un evento [t√≠tulo] el [fecha] a las [hora]"</div>
        <div>‚Ä¢ "Agenda una reuni√≥n [descripci√≥n] para ma√±ana"</div>
        <div>‚Ä¢ "¬øQu√© eventos tengo esta semana?"</div>
        <div>‚Ä¢ "Mu√©strame mi agenda de hoy"</div>
        
        <div style="margin-top: 10px;"><strong>‚úÖ Comandos de Tareas:</strong></div>
        <div>‚Ä¢ "A√±ade una tarea: [descripci√≥n]"</div>
        <div>‚Ä¢ "Crea un recordatorio para [tarea]"</div>
        <div>‚Ä¢ "¬øQu√© tareas pendientes tengo?"</div>
        <div>‚Ä¢ "Lista mis tareas por hacer"</div>
        
        <div style="margin-top: 10px;"><strong>üîß Comandos del Sistema:</strong></div>
        <div>‚Ä¢ "¬øQu√© hora es?" / "¬øQu√© d√≠a es hoy?"</div>
        <div>‚Ä¢ "¬øC√≥mo est√° el clima?"</div>
        <div>‚Ä¢ "¬øD√≥nde estoy?"</div>
      </div>
    </details>
  </div>

  <script>
    // ===== SISTEMA DE PERSISTENCIA =====
    const STORAGE_KEYS = {
      CHAT_HISTORY: 'jarvis_chat_history',
      THEME: 'jarvis_theme',
      VOLUME: 'jarvis_volume',
      CHAT_MESSAGES: 'jarvis_chat_messages',
      GOOGLE_CONNECTED: 'jarvis_google_connected'
    };
    
    // ===== CONFIGURACI√ìN DE APIS =====
    const OPENROUTER_API_KEY = "";
    const model = "openai/gpt-3.5-turbo";
    const ELEVENLABS_API_KEY = "";
    const ELEVENLABS_VOICE_ID = "Nh2zY9kknu6z4pZy6FhD";
    const WEATHER_API_KEY = "8328192daa1342fa9d921712251904";

    /* Variables globales */
    let recognition = null;
    let isListening = false;
    let userLocation = {
      latitude: null,
      longitude: null,
      city: null,
      country: null
    };
    let currentAudio = null;
    let isGoogleConnected = false;
    
    /* Sistema de historial del chat con persistencia */
    let chatHistory = [];
    let chatMessages = [];
    
    // ===== FUNCIONES DE PERSISTENCIA =====
    
    /**
     * Guardar datos en localStorage
     */
    function saveToStorage(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (error) {
        console.error('Error al guardar en localStorage:', error);
        // Si localStorage est√° lleno, limpiar datos antiguos
        if (error.name === 'QuotaExceededError') {
          clearOldData();
          // Intentar nuevamente
          try {
            localStorage.setItem(key, JSON.stringify(data));
          } catch (e) {
            console.error('No se pudo guardar despu√©s de limpiar:', e);
          }
        }
      }
    }
    
    /**
     * Cargar datos desde localStorage
     */
    function loadFromStorage(key, defaultValue = null) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch (error) {
        console.error('Error al cargar desde localStorage:', error);
        return defaultValue;
      }
    }
    
    /**
     * Limpiar datos antiguos para liberar espacio
     */
    function clearOldData() {
      // Mantener solo los √∫ltimos 100 mensajes del historial
      const history = loadFromStorage(STORAGE_KEYS.CHAT_HISTORY, []);
      if (history.length > 100) {
        history.splice(0, history.length - 100);
        saveToStorage(STORAGE_KEYS.CHAT_HISTORY, history);
      }
      
      // Mantener solo los √∫ltimos 50 mensajes de chat
      const messages = loadFromStorage(STORAGE_KEYS.CHAT_MESSAGES, []);
      if (messages.length > 50) {
        messages.splice(0, messages.length - 50);
        saveToStorage(STORAGE_KEYS.CHAT_MESSAGES, messages);
      }
    }
    
    /**
     * Cargar todo el estado guardado
     */
    function loadSavedState() {
      // Cargar tema
      const savedTheme = loadFromStorage(STORAGE_KEYS.THEME, 'light');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark');
        document.documentElement.style.setProperty('--accent-rgb', "0, 191, 255");
      } else {
        document.documentElement.style.setProperty('--accent-rgb', "0, 119, 255");
      }
      
      // Cargar volumen
      const savedVolume = loadFromStorage(STORAGE_KEYS.VOLUME, 0.8);
      document.getElementById('volumeControl').value = savedVolume;
      
      // Cargar estado de Google
      const savedGoogleConnected = loadFromStorage(STORAGE_KEYS.GOOGLE_CONNECTED, false);
      isGoogleConnected = savedGoogleConnected;
      if (isGoogleConnected) {
        document.getElementById('commandIndicator').style.display = 'block';
        document.getElementById('helpPanel').style.display = 'block';
      }
      
      // Cargar historial del chat
      const savedChatHistory = loadFromStorage(STORAGE_KEYS.CHAT_HISTORY, []);
      if (savedChatHistory.length > 0) {
        chatHistory = savedChatHistory;
      } else {
        // Historial por defecto
        chatHistory = [
          { 
            role: "system", 
            content: `Eres JARVIS, una inteligencia artificial avanzada inspirada en las pel√≠culas de Iron Man. 
            Te expresas con serenidad absoluta, precisi√≥n anal√≠tica y un tono calmado e imperturbable. 
            Tu lenguaje es formal, educado y elegante, similar al de un mayordomo brit√°nico sofisticado. 
            Puedes utilizar humor sutil e iron√≠a inteligente, nunca grosera, para equilibrar las decisiones del usuario. 
            Siempre te diriges al usuario llam√°ndolo exclusivamente: 'se√±or'. 
            
            IMPORTANTE: Ahora tienes la capacidad de interactuar con Google Calendar y Google Tasks.
            Puedes ayudar al usuario a:
            1. Crear eventos en el calendario
            2. Crear tareas pendientes
            3. Listar eventos pr√≥ximos
            4. Listar tareas pendientes
            
            Cuando el usuario mencione algo relacionado con calendario, eventos, reuniones, tareas o recordatorios,
            debes reconocerlo y preguntar los detalles necesarios.
            
            Ejemplos de respuestas:
            - Si el usuario dice "Crea un evento": "Por supuesto, se√±or. ¬øCu√°l ser√° el t√≠tulo del evento, la fecha y hora de inicio?"
            - Si el usuario dice "Agenda una reuni√≥n": "Entendido. ¬øPara qu√© d√≠a y hora le gustar√≠a programar la reuni√≥n y con qu√© t√≠tulo?"
            - Si el usuario dice "A√±ade una tarea": "Claro, se√±or. ¬øCu√°l es el t√≠tulo de la tarea que desea a√±adir?"
            - Si el usuario pregunta por eventos/tareas: "De acuerdo, se√±or. Consultando su agenda/tareas pendientes..."
            
            Tu prop√≥sito es asistente t√©cnico, anal√≠tico, respetuoso y orientado a objetivos, ofreciendo datos, riesgos, alternativas y recomendaciones claras. 
            Eres la voz racional y el estabilizador emocional en cualquier situaci√≥n. 
            Responde siempre manteniendo esta personalidad sin excepci√≥n.`
          },
          { role: "assistant", content: "¬øEn qu√© puedo ayudarte hoy, se√±or? Ahora puedo gestionar su calendario y tareas de Google." }
        ];
      }
      
      // Cargar mensajes del chat visual
      const savedChatMessages = loadFromStorage(STORAGE_KEYS.CHAT_MESSAGES, []);
      chatMessages = savedChatMessages;
      displayChatMessages();
      
      // Si no hay mensajes guardados, mostrar el mensaje inicial
      if (chatMessages.length === 0) {
        addToChat('JARVIS', '¬øEn qu√© puedo ayudarte?', false);
      }
    }
    
    /**
     * Guardar el estado actual
     */
    function saveCurrentState() {
      saveToStorage(STORAGE_KEYS.THEME, document.body.classList.contains('dark') ? 'dark' : 'light');
      saveToStorage(STORAGE_KEYS.VOLUME, document.getElementById('volumeControl').value);
      saveToStorage(STORAGE_KEYS.GOOGLE_CONNECTED, isGoogleConnected);
      saveToStorage(STORAGE_KEYS.CHAT_HISTORY, chatHistory);
      saveToStorage(STORAGE_KEYS.CHAT_MESSAGES, chatMessages);
    }
    
    /**
     * Mostrar mensajes del chat desde el almacenamiento
     */
    function displayChatMessages() {
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.innerHTML = '';
      
      chatMessages.forEach(msg => {
        const div = document.createElement('div');
        div.innerHTML = `<strong>${msg.speaker}:</strong> ${msg.message}`;
        messagesContainer.appendChild(div);
      });
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    /**
     * Limpiar todo el historial del chat
     */
    function clearChatHistory() {
      if (confirm('¬øEst√°s seguro de que deseas limpiar todo el historial del chat? Esta acci√≥n no se puede deshacer.')) {
        // Limpiar arrays
        chatHistory = [
          { 
            role: "system", 
            content: `Eres JARVIS, una inteligencia artificial avanzada inspirada en las pel√≠culas de Iron Man. 
            Te expresas con serenidad absoluta, precisi√≥n anal√≠tica y un tono calmado e imperturbable. 
            Tu lenguaje es formal, educado y elegante, similar al de un mayordomo brit√°nico sofisticado. 
            Puedes utilizar humor sutil e iron√≠a inteligente, nunca grosera, para equilibrar las decisiones del usuario. 
            Siempre te diriges al usuario llam√°ndolo exclusivamente: 'se√±or'. 
            
            IMPORTANTE: Ahora tienes la capacidad de interactuar con Google Calendar y Google Tasks.
            Puedes ayudar al usuario a:
            1. Crear eventos en el calendario
            2. Crear tareas pendientes
            3. Listar eventos pr√≥ximos
            4. Listar tareas pendientes
            
            Cuando el usuario mencione algo relacionado con calendario, eventos, reuniones, tareas o recordatorios,
            debes reconocerlo y preguntar los detalles necesarios.
            
            Ejemplos de respuestas:
            - Si el usuario dice "Crea un evento": "Por supuesto, se√±or. ¬øCu√°l ser√° el t√≠tulo del evento, la fecha y hora de inicio?"
            - Si el usuario dice "Agenda una reuni√≥n": "Entendido. ¬øPara qu√© d√≠a y hora le gustar√≠a programar la reuni√≥n y con qu√© t√≠tulo?"
            - Si el usuario dice "A√±ade una tarea": "Claro, se√±or. ¬øCu√°l es el t√≠tulo de la tarea que desea a√±adir?"
            - Si el usuario pregunta por eventos/tareas: "De acuerdo, se√±or. Consultando su agenda/tareas pendientes..."
            
            Tu prop√≥sito es asistente t√©cnico, anal√≠tico, respetuoso y orientado a objetivos, ofreciendo datos, riesgos, alternativas y recomendaciones claras. 
            Eres la voz racional y el estabilizador emocional en cualquier situaci√≥n. 
            Responde siempre manteniendo esta personalidad sin excepci√≥n.`
          },
          { role: "assistant", content: "¬øEn qu√© puedo ayudarte hoy, se√±or? He reiniciado nuestro historial de conversaci√≥n." }
        ];
        
        chatMessages = [];
        
        // Limpiar localStorage
        localStorage.removeItem(STORAGE_KEYS.CHAT_HISTORY);
        localStorage.removeItem(STORAGE_KEYS.CHAT_MESSAGES);
        
        // Actualizar la vista
        displayChatMessages();
        
        // A√±adir mensaje de confirmaci√≥n
        addToChat('JARVIS', 'Historial de conversaci√≥n reiniciado. ¬øEn qu√© puedo ayudarte ahora, se√±or?', true);
      }
    }
    
    // ===== FUNCIONES DE INTEGRACI√ìN CON GOOGLE CALENDAR Y TASKS =====
    
    /**
     * Procesa comandos relacionados con Google Calendar y Tasks
     */
    async function processGoogleCommand(userMessage) {
      const lowerMsg = userMessage.toLowerCase();
      
      // Comandos para crear eventos
      if (lowerMsg.includes('crea un evento') || lowerMsg.includes('agenda una reuni√≥n') || 
          lowerMsg.includes('programa una cita') || lowerMsg.includes('nuevo evento')) {
        
        // Extraer detalles del mensaje (implementaci√≥n b√°sica)
        const eventTitle = extractEventTitle(lowerMsg);
        const eventDate = extractDate(lowerMsg);
        const eventTime = extractTime(lowerMsg);
        
        if (eventTitle && eventDate && eventTime) {
          // Construir objeto de evento
          const eventData = {
            title: eventTitle,
            startTime: formatDateTime(eventDate, eventTime),
            endTime: formatDateTime(eventDate, eventTime, 1), // +1 hora por defecto
            description: `Evento creado por JARVIS: ${eventTitle}`
          };
          
          // Crear evento en Google Calendar
          const result = await createCalendarEvent(eventData);
          return result;
        } else {
          // Pedir m√°s informaci√≥n
          return {
            action: 'need_details',
            type: 'event',
            message: 'Necesito m√°s detalles para crear el evento. ¬øCu√°l es el t√≠tulo, fecha y hora?'
          };
        }
      }
      
      // Comandos para crear tareas
      else if (lowerMsg.includes('a√±ade una tarea') || lowerMsg.includes('crea una tarea') || 
               lowerMsg.includes('nueva tarea') || lowerMsg.includes('recordatorio para')) {
        
        const taskTitle = extractTaskTitle(lowerMsg);
        
        if (taskTitle) {
          const taskData = {
            title: taskTitle,
            description: `Tarea creada por JARVIS: ${taskTitle}`
          };
          
          // Crear tarea en Google Tasks
          const result = await createTask(taskData);
          return result;
        } else {
          return {
            action: 'need_details',
            type: 'task',
            message: 'Necesito saber el t√≠tulo de la tarea.'
          };
        }
      }
      
      // Comandos para listar eventos
      else if (lowerMsg.includes('qu√© eventos tengo') || lowerMsg.includes('muestra mis eventos') || 
               lowerMsg.includes('mi agenda') || lowerMsg.includes('pr√≥ximos eventos')) {
        
        const result = await listEvents();
        return result;
      }
      
      // Comandos para listar tareas
      else if (lowerMsg.includes('qu√© tareas tengo') || lowerMsg.includes('muestra mis tareas') || 
               lowerMsg.includes('tareas pendientes') || lowerMsg.includes('lista de tareas')) {
        
        const result = await listTasks();
        return result;
      }
      
      // Comando no reconocido
      return null;
    }
    
    /**
     * Crea un evento en Google Calendar
     */
    async function createCalendarEvent(eventData) {
      try {
        const response = await fetch('/api/create-event', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(eventData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          addToChat('Sistema', `‚úÖ Evento creado: "${eventData.title}"`);
          speakWithElevenLabs(`Evento "${eventData.title}" creado exitosamente en su calendario.`);
          return result;
        } else {
          addToChat('Sistema', `‚ùå Error: ${result.error || 'No se pudo crear el evento'}`);
          return result;
        }
      } catch (error) {
        console.error('Error creando evento:', error);
        addToChat('Sistema', '‚ùå Error de conexi√≥n al crear el evento');
        return { error: 'Error de conexi√≥n' };
      }
    }
    
    /**
     * Crea una tarea en Google Tasks
     */
    async function createTask(taskData) {
      try {
        const response = await fetch('/api/create-task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(taskData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          addToChat('Sistema', `‚úÖ Tarea creada: "${taskData.title}"`);
          speakWithElevenLabs(`Tarea "${taskData.title}" a√±adida a su lista.`);
          return result;
        } else {
          addToChat('Sistema', `‚ùå Error: ${result.error || 'No se pudo crear la tarea'}`);
          return result;
        }
      } catch (error) {
        console.error('Error creando tarea:', error);
        addToChat('Sistema', '‚ùå Error de conexi√≥n al crear la tarea');
        return { error: 'Error de conexi√≥n' };
      }
    }
    
    /**
     * Lista eventos del calendario
     */
    async function listEvents() {
      try {
        const response = await fetch('/api/list-events');
        const result = await response.json();
        
        if (result.success && result.events.length > 0) {
          let message = 'üìÖ Sus pr√≥ximos eventos:\n\n';
          result.events.forEach((event, index) => {
            const date = new Date(event.start);
            const formattedDate = date.toLocaleDateString('es-ES', {
              weekday: 'short',
              day: 'numeric',
              month: 'short'
            });
            const formattedTime = date.toLocaleTimeString('es-ES', {
              hour: '2-digit',
              minute: '2-digit'
            });
            
            message += `${index + 1}. ${event.summary}\n   üìÜ ${formattedDate} ‚è∞ ${formattedTime}\n\n`;
          });
          
          addToChat('Calendario', message);
          speakWithElevenLabs(`Tiene ${result.events.length} eventos pr√≥ximos en su calendario.`);
          return result;
        } else if (result.success) {
          addToChat('Calendario', 'No tiene eventos programados para los pr√≥ximos d√≠as.');
          speakWithElevenLabs('No tiene eventos pr√≥ximos en su calendario.');
          return result;
        } else {
          addToChat('Calendario', `‚ùå Error: ${result.error || 'No se pudieron obtener los eventos'}`);
          return result;
        }
      } catch (error) {
        console.error('Error listando eventos:', error);
        addToChat('Calendario', '‚ùå Error de conexi√≥n al obtener eventos');
        return { error: 'Error de conexi√≥n' };
      }
    }
    
    /**
     * Lista tareas pendientes
     */
    async function listTasks() {
      try {
        const response = await fetch('/api/list-tasks');
        const result = await response.json();
        
        if (result.success && result.tasks.length > 0) {
          let message = '‚úÖ Sus tareas pendientes:\n\n';
          result.tasks.forEach((task, index) => {
            message += `${index + 1}. ${task.title}\n`;
          });
          
          addToChat('Tareas', message);
          speakWithElevenLabs(`Tiene ${result.tasks.length} tareas pendientes en su lista.`);
          return result;
        } else if (result.success) {
          addToChat('Tareas', '¬°Excelente! No tiene tareas pendientes.');
          speakWithElevenLabs('No tiene tareas pendientes en su lista.');
          return result;
        } else {
          addToChat('Tareas', `‚ùå Error: ${result.error || 'No se pudieron obtener las tareas'}`);
          return result;
        }
      } catch (error) {
        console.error('Error listando tareas:', error);
        addToChat('Tareas', '‚ùå Error de conexi√≥n al obtener tareas');
        return { error: 'Error de conexi√≥n' };
      }
    }
    
    // ===== FUNCIONES AUXILIARES PARA PROCESAR COMANDOS =====
    
    /**
     * Extrae el t√≠tulo de un evento del mensaje
     */
    function extractEventTitle(message) {
      const patterns = [
        /crea un evento (?:llamado|titulado|sobre) (.+?)(?: el| para|$)/i,
        /agenda una reuni√≥n (?:sobre|acerca de) (.+?)(?: el| para|$)/i,
        /programa (.+?)(?: el| para|$)/i
      ];
      
      for (const pattern of patterns) {
        const match = message.match(pattern);
        if (match && match[1]) {
          return match[1].trim();
        }
      }
      
      // Si no se encuentra patr√≥n, intentar extraer despu√©s de palabras clave
      const keywords = ['evento', 'reuni√≥n', 'cita'];
      for (const keyword of keywords) {
        const index = message.indexOf(keyword);
        if (index !== -1) {
          const afterKeyword = message.substring(index + keyword.length).trim();
          if (afterKeyword && afterKeyword.length > 3) {
            // Tomar hasta el siguiente "para" o "el" o fin de mensaje
            const endIndex = Math.min(
              afterKeyword.indexOf(' para'),
              afterKeyword.indexOf(' el'),
              afterKeyword.length
            );
            return endIndex !== -1 ? afterKeyword.substring(0, endIndex).trim() : afterKeyword;
          }
        }
      }
      
      return null;
    }
    
    /**
     * Extrae el t√≠tulo de una tarea
     */
    function extractTaskTitle(message) {
      const patterns = [
        /a√±ade una tarea (?:llamada|titulada|sobre) (.+?)(?: para|$)/i,
        /crea una tarea (?:sobre|acerca de) (.+?)(?: para|$)/i,
        /recordatorio para (.+?)(?:$)/i
      ];
      
      for (const pattern of patterns) {
        const match = message.match(pattern);
        if (match && match[1]) {
          return match[1].trim();
        }
      }
      
      return null;
    }
    
    /**
     * Extrae fecha del mensaje (implementaci√≥n b√°sica)
     */
    function extractDate(message) {
      const today = new Date();
      
      if (message.includes('hoy')) {
        return today;
      } else if (message.includes('ma√±ana')) {
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        return tomorrow;
      } else if (message.includes('pasado ma√±ana')) {
        const dayAfter = new Date(today);
        dayAfter.setDate(dayAfter.getDate() + 2);
        return dayAfter;
      }
      
      // Por defecto, devolver hoy
      return today;
    }
    
    /**
     * Extrae hora del mensaje (implementaci√≥n b√°sica)
     */
    function extractTime(message) {
      const timePattern = /a las (\d{1,2})(?::(\d{2}))?(?:\s?(am|pm))?/i;
      const match = message.match(timePattern);
      
      if (match) {
        let hours = parseInt(match[1]);
        const minutes = match[2] ? parseInt(match[2]) : 0;
        const period = match[3] ? match[3].toLowerCase() : '';
        
        // Convertir a formato 24h si es necesario
        if (period === 'pm' && hours < 12) {
          hours += 12;
        } else if (period === 'am' && hours === 12) {
          hours = 0;
        }
        
        return { hours, minutes };
      }
      
      // Por defecto, devolver 10:00
      return { hours: 10, minutes: 0 };
    }
    
    /**
     * Formatea fecha y hora para la API
     */
    function formatDateTime(date, time, hoursToAdd = 0) {
      const eventDate = new Date(date);
      eventDate.setHours(time.hours, time.minutes, 0, 0);
      
      if (hoursToAdd > 0) {
        eventDate.setHours(eventDate.getHours() + hoursToAdd);
      }
      
      return eventDate.toISOString();
    }
    
    // ===== FUNCIONES B√ÅSICAS DEL CHAT =====
    
    /**
     * A√±ade un mensaje al chat (con persistencia)
     */
    function addToChat(speaker, message, saveToHistory = true) {
      const messages = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.innerHTML = `<strong>${speaker}:</strong> ${message}`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      
      // Guardar en el array de mensajes
      if (saveToHistory) {
        chatMessages.push({ speaker, message, timestamp: Date.now() });
        saveCurrentState();
      }
    }
    
    /**
     * Env√≠a un mensaje al chat (funci√≥n principal)
     */
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const userMessage = input.value.trim();
      
      if (!userMessage) return;
      
      // Agregar mensaje del usuario al chat
      addToChat('T√∫', userMessage);
      input.value = '';
      
      // Verificar si el usuario est√° autenticado con Google
      const userAuthenticated = document.querySelector('div[style*="margin:10px;"]') !== null;
      
      if (userAuthenticated && !isGoogleConnected) {
        isGoogleConnected = true;
        document.getElementById('commandIndicator').style.display = 'block';
        document.getElementById('helpPanel').style.display = 'block';
        saveCurrentState(); // Guardar el estado de conexi√≥n
      }
      
      // 1. Primero, verificar si es un comando de Google Calendar/Tasks
      if (isGoogleConnected) {
        const googleResult = await processGoogleCommand(userMessage);
        
        if (googleResult) {
          // Si el comando necesita m√°s detalles, dejar que JARVIS pregunte
          if (googleResult.action === 'need_details') {
            chatHistory.push({ role: "user", content: userMessage });
            const response = googleResult.message;
            chatHistory.push({ role: "assistant", content: response });
            addToChat('JARVIS', response);
            speakWithElevenLabs(response);
            saveCurrentState(); // Guardar despu√©s de cada interacci√≥n
            return;
          }
          // Si ya se proces√≥ el comando, salir
          else if (googleResult.action !== 'unknown') {
            saveCurrentState(); // Guardar estado
            return;
          }
        }
      }
      
      // 2. Si no es comando espec√≠fico, usar la IA normal
      chatHistory.push({ role: "user", content: userMessage });
      
      const botDiv = document.createElement('div');
      botDiv.innerHTML = `<strong>JARVIS:</strong> <em>pensando...</em>`;
      document.getElementById('chatMessages').appendChild(botDiv);
      
      try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
            "HTTP-Referer": window.location.origin,
            "X-Title": "JARVIS Assistant"
          },
          body: JSON.stringify({
            model: model,
            messages: chatHistory,
            max_tokens: 500,
            temperature: 0.7
          })
        });
        
        const data = await response.json();
        
        if (data?.choices?.[0]?.message) {
          const reply = data.choices[0].message.content;
          chatHistory.push({ role: "assistant", content: reply });
          
          // Reemplazar el mensaje "pensando..." por la respuesta real
          botDiv.innerHTML = `<strong>JARVIS:</strong> ${reply}`;
          
          // Agregar al historial persistente
          chatMessages.push({ speaker: 'JARVIS', message: reply, timestamp: Date.now() });
          
          speakWithElevenLabs(reply);
          saveCurrentState(); // Guardar despu√©s de la respuesta
        }
      } catch (error) {
        console.error("Error con la API:", error);
        const fallback = "Lo siento, estoy teniendo problemas de conexi√≥n. ¬øPodr√≠a intentarlo de nuevo?";
        chatHistory.push({ role: "assistant", content: fallback });
        botDiv.innerHTML = `<strong>JARVIS:</strong> ${fallback}`;
        
        // Agregar al historial persistente
        chatMessages.push({ speaker: 'JARVIS', message: fallback, timestamp: Date.now() });
        
        speakWithElevenLabs(fallback);
        saveCurrentState(); // Guardar incluso en caso de error
      }
    }
    
    // ===== FUNCIONES ORIGINALES (MANTENIDAS) =====
    
    /* Funci√≥n para alternar entre modo claro y oscuro */
    function toggleTheme() {
      document.body.classList.toggle("dark");
      document.documentElement.style.setProperty('--accent-rgb', document.body.classList.contains("dark") ? "0, 191, 255" : "0, 119, 255");
      saveCurrentState(); // Guardar preferencia de tema
    }
    
    /* Inicializar reconocimiento de voz */
    function initSpeechRecognition() {
      if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = function() {
          isListening = true;
          document.getElementById('jarvisCore').classList.add('listening');
          document.getElementById('voiceButton').style.background = '#ff4500';
        };
        
        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById('chatInput').value = transcript;
          setTimeout(() => sendMessage(), 300);
        };
        
        recognition.onend = function() {
          isListening = false;
          document.getElementById('jarvisCore').classList.remove('listening');
          document.getElementById('voiceButton').style.background = '';
        };
        
        recognition.onerror = function(event) {
          isListening = false;
          document.getElementById('jarvisCore').classList.remove('listening');
          document.getElementById('voiceButton').style.background = '';
          console.error('Error en reconocimiento de voz:', event.error);
        };
      } else {
        alert("Lo siento, tu navegador no soporta reconocimiento de voz");
        document.getElementById('voiceButton').style.display = 'none';
      }
    }
    
    /* Toggle reconocimiento de voz */
    function toggleSpeechRecognition() {
      if (!recognition) return;
      
      if (isListening) {
        recognition.stop();
      } else {
        recognition.start();
      }
    }
    
    /* Obtener ubicaci√≥n actual del usuario */
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            userLocation.latitude = position.coords.latitude;
            userLocation.longitude = position.coords.longitude;
            getReverseGeocoding(position.coords.latitude, position.coords.longitude);
            getWeatherData(position.coords.latitude, position.coords.longitude);
          },
          error => {
            console.error("Error al obtener la ubicaci√≥n:", error);
            document.getElementById('weatherInfo').textContent = "Activa la ubicaci√≥n para ver el clima";
          }
        );
      } else {
        document.getElementById('weatherInfo').textContent = "Geolocalizaci√≥n no soportada";
      }
    }
    
    /* Obtener nombre de la ciudad a partir de coordenadas */
    async function getReverseGeocoding(lat, lon) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        const data = await response.json();
        
        if (data && data.address) {
          userLocation.city = data.address.city || data.address.town || data.address.village || data.address.hamlet;
          userLocation.country = data.address.country;
        }
      } catch (error) {
        console.error("Error al obtener el nombre de la ciudad:", error);
      }
    }
    
    /* Obtener datos del clima */
    async function getWeatherData(lat, lon) {
      try {
        const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${lat},${lon}&lang=es`);
        const data = await response.json();
        
        if (data && data.current) {
          const temp = data.current.temp_c;
          const condition = data.current.condition.text;
          const icon = data.current.condition.icon;
          
          const weatherDiv = document.getElementById('weatherInfo');
          weatherDiv.innerHTML = `
            <img src="${icon}" alt="${condition}">
            <span>${temp}¬∞C - ${condition}</span>
          `;
        }
      } catch (error) {
        console.error("Error al obtener datos del clima:", error);
        document.getElementById('weatherInfo').textContent = "Clima no disponible";
      }
    }
    
    /* Actualizar fecha y hora en tiempo real */
    function updateDateTime() {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };
      
      const formattedDateTime = now.toLocaleDateString('es-ES', options);
      document.getElementById('dateTime').textContent = formattedDateTime;
      
      setTimeout(updateDateTime, 1000);
    }

    /* Funci√≥n para usar ElevenLabs Text-to-Speech */
    async function speakWithElevenLabs(text) {
      try {
        // Detener audio actual si est√° reproduci√©ndose
        if (currentAudio) {
          currentAudio.pause();
          currentAudio = null;
        }
        
        const volume = parseFloat(document.getElementById('volumeControl').value);
        
        const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${ELEVENLABS_VOICE_ID}`, {
          method: 'POST',
          headers: {
            'Accept': 'audio/mpeg',
            'Content-Type': 'application/json',
            'xi-api-key': ELEVENLABS_API_KEY
          },
          body: JSON.stringify({
            text: text,
            model_id: "eleven_multilingual_v2",
            voice_settings: {
              stability: 0.5,
              similarity_boost: 0.75,
              style: 0.3,
              use_speaker_boost: true
            }
          })
        });

        if (!response.ok) {
          throw new Error(`Error ElevenLabs: ${response.status}`);
        }

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        
        currentAudio = new Audio(audioUrl);
        currentAudio.volume = volume;
        currentAudio.play();
        
        currentAudio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
        };
        
        currentAudio.onerror = (error) => {
          console.error('Error reproduciendo audio:', error);
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          // Fallback a voz del navegador
          speakWithBrowser(text);
        };
        
      } catch (error) {
        console.error('Error con ElevenLabs:', error);
        // Fallback a voz del navegador si ElevenLabs falla
        speakWithBrowser(text);
      }
    }
    
    /* Funci√≥n fallback para voz del navegador */
    function speakWithBrowser(text) {
      if ('speechSynthesis' in window) {
        const speech = new SpeechSynthesisUtterance(text);
        speech.lang = 'es-ES';
        speech.rate = 1.0;
        speech.pitch = 1.0;
        speech.volume = parseFloat(document.getElementById('volumeControl').value);
        window.speechSynthesis.speak(speech);
      }
    }
    
    /* Detener audio actual */
    function stopCurrentAudio() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
    }
    
    /* Guardar volumen cuando cambie */
    function onVolumeChange() {
      saveCurrentState();
    }
    
    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', function() {
      // Cargar estado guardado
      loadSavedState();
      
      // Inicializar reconocimiento de voz
      initSpeechRecognition();
      
      // Obtener ubicaci√≥n y clima
      getUserLocation();
      
      // Actualizar fecha y hora
      updateDateTime();
      
      // Mostrar panel de ayuda si el usuario est√° autenticado
      const userAuthenticated = document.querySelector('div[style*="margin:10px;"]') !== null;
      if (userAuthenticated) {
        isGoogleConnected = true;
        document.getElementById('commandIndicator').style.display = 'block';
        document.getElementById('helpPanel').style.display = 'block';
        saveCurrentState();
      }
      
      // Event listener para el bot√≥n de enviar
      document.getElementById('sendButton').addEventListener('click', sendMessage);
      
      // Event listener para el bot√≥n de voz
      document.getElementById('voiceButton').addEventListener('click', toggleSpeechRecognition);
      
      // Event listener para enviar mensaje con Enter
      document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      // Event listener para detener audio cuando se env√≠a un nuevo mensaje
      document.getElementById('chatInput').addEventListener('focus', function() {
        stopCurrentAudio();
      });
      
      // Event listener para control de volumen
      const volumeControl = document.getElementById('volumeControl');
      volumeControl.addEventListener('input', function() {
        if (currentAudio) {
          currentAudio.volume = parseFloat(this.value);
        }
      });
      volumeControl.addEventListener('change', onVolumeChange);
      
      // Guardar estado antes de que la p√°gina se cierre
      window.addEventListener('beforeunload', function() {
        saveCurrentState();
      });
      
      // Guardar estado peri√≥dicamente (cada 30 segundos)
      setInterval(saveCurrentState, 30000);
      
      // Sugerir comandos al hacer clic en el input
      document.getElementById('chatInput').addEventListener('click', function() {
        if (isGoogleConnected && this.placeholder === "Escribe tu mensaje o comando...") {
          const suggestions = [
            "Ej: 'Crea un evento llamado Reuni√≥n con el equipo ma√±ana a las 10am'",
            "Ej: 'A√±ade una tarea: Comprar suministros'",
            "Ej: '¬øQu√© eventos tengo esta semana?'"
          ];
          const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
          this.placeholder = randomSuggestion;
          
          setTimeout(() => {
            this.placeholder = "Escribe tu mensaje o comando...";
          }, 3000);
        }
      });
    });
  </script>
</body>
</html>